<div class="admin-dashboard">
  <div class="admin-header">
    <h1 style="cursor: pointer;" (click)="goToProfile()">Tableau de bord Admin RH</h1>
    <div class="admin-actions">
      <app-notifications></app-notifications>
      <button class="btn btn-secondary" (click)="goToProfile()">Profil</button>
      <button class="btn btn-secondary" routerLink="/home">Retour à l'accueil</button>
    </div>
  </div>

  <!-- Navigation entre les vues -->
  <div class="admin-tabs">
    <button class="tab-btn" [class.active]="activeView === 'list'" (click)="activeView = 'list'">
      <i class="fas fa-list"></i> Liste des demandes
    </button>
    <button class="tab-btn" [class.active]="activeView === 'calendar'" (click)="activeView = 'calendar'">
      <i class="fas fa-calendar-alt"></i> Calendrier
    </button>
    <button class="tab-btn" [class.active]="activeView === 'users'" (click)="activeView = 'users'">
      <i class="fas fa-users"></i> Gestion des utilisateurs
    </button>
  </div>

  <!-- Vue Liste des demandes -->
  <div class="admin-content" *ngIf="activeView === 'list'">
    <div class="header-section">
      <h2>Liste des demandes</h2>
      <div class="filter-section">
        <button class="btn" [class.btn-primary]="currentFilter === 'all'" (click)="filterRequests('all')">Toutes</button>
        <button class="btn" [class.btn-primary]="currentFilter === 'chef'" (click)="filterRequests('chef')">Traitées par le chef</button>
        <button class="btn" [class.btn-primary]="currentFilter === 'pending'" (click)="filterRequests('pending')">En attente</button>
      </div>
      <app-search-bar (search)="onSearch($event)"></app-search-bar>
    </div>

    <div class="table-responsive">
      <table class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Date</th>
            <th>Type</th>
            <th>Employé</th>
            <th>Status</th>
            <th>Observation Chef</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let request of filteredRequests">
            <td>{{request.id}}</td>
            <td>{{request.createdAt | date:'dd/MM/yyyy'}}</td>
            <td>{{request.type}}</td>
            <td>{{request.user?.firstname}} {{request.user?.lastname}}</td>
            <td>
              <span [class]="'status-' + (request.status ? request.status.toLowerCase() : '')">
                {{request.status}}
              </span>
            </td>
            <td>{{request.chefObservation || 'Pas d\'observation'}}</td>
            <td>
              <button class="btn btn-primary" (click)="viewRequestDetails(request)">
                <i class="fas fa-eye"></i> Détails
              </button>

              <!-- Boutons pour les demandes en attente -->
              <ng-container *ngIf="request.status === 'PENDING'">
                <button class="btn btn-success" (click)="approveRequest(request)">
                  <i class="fas fa-check"></i> Approuver
                </button>
                <button class="btn btn-danger" (click)="rejectRequest(request)">
                  <i class="fas fa-times"></i> Rejeter
                </button>
              </ng-container>

              <!-- Boutons pour les demandes traitées par le chef -->
              <ng-container *ngIf="request.status === 'CHEF_APPROVED' || request.status === 'CHEF_REJECTED'">
                <button class="btn btn-success" (click)="finalApproveRequest(request)">
                  <i class="fas fa-check-double"></i> Approbation finale
                </button>
                <button class="btn btn-danger" (click)="finalRejectRequest(request)">
                  <i class="fas fa-ban"></i> Rejet final
                </button>
              </ng-container>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Vue Calendrier -->
  <div class="admin-content calendar-view" *ngIf="activeView === 'calendar'">
    <div class="calendar-header">
      <h2>Calendrier des demandes</h2>
      <div class="calendar-navigation">
        <button class="btn btn-outline-primary" (click)="previousMonth()">
          <i class="fas fa-chevron-left"></i>
        </button>
        <h3 class="current-month">{{ months[currentMonth.getMonth()] }} {{ currentMonth.getFullYear() }}</h3>
        <button class="btn btn-outline-primary" (click)="nextMonth()">
          <i class="fas fa-chevron-right"></i>
        </button>
      </div>
    </div>

    <div class="calendar-grid">
      <!-- Jours de la semaine -->
      <div class="weekday" *ngFor="let day of weekdays">
        {{ day }}
      </div>

      <!-- Jours du mois avec les demandes -->
      <div class="day" *ngFor="let day of calendarDays">
        <div class="day-header">{{ day.number > 0 ? day.number : '' }}</div>
        <div class="day-content" *ngIf="day.number > 0">
          <div class="request-item"
               *ngFor="let request of day.requests"
               [ngClass]="getStatusClass(request.status || '')"
               (click)="viewRequestDetails(request)">
            {{ request.type }}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Vue Gestion des utilisateurs -->
  <div class="admin-content" *ngIf="activeView === 'users'">
    <div class="header-section">
      <h2><i class="fas fa-users"></i> Gestion des utilisateurs</h2>
      <div class="users-stats">
        <div class="stat-card">
          <span class="stat-number">{{users.length}}</span>
          <span class="stat-label">Total utilisateurs</span>
        </div>
        <div class="stat-card">
          <span class="stat-number">{{getUsersByRole('admin').length}}</span>
          <span class="stat-label">Administrateurs</span>
        </div>
        <div class="stat-card">
          <span class="stat-number">{{getUsersByRole('chef').length}}</span>
          <span class="stat-label">Chefs</span>
        </div>
        <div class="stat-card">
          <span class="stat-number">{{getUsersByRole('user').length}}</span>
          <span class="stat-label">Employés</span>
        </div>
      </div>
    </div>

    <div class="users-table-container">
      <table class="users-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nom complet</th>
            <th>Email</th>
            <th>Rôle</th>
            <th>Département</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of users" class="user-row">
            <td>{{user.id}}</td>
            <td>
              <div class="user-info">
                <strong>{{user.firstname}} {{user.lastname}}</strong>
                <small *ngIf="user.cin">CIN: {{user.cin}}</small>
              </div>
            </td>
            <td>{{user.email}}</td>
            <td>
              <span class="role-badge" [class]="'role-' + user.role">
                {{user.role}}
              </span>
            </td>
            <td>{{user.department_name || 'Non assigné'}}</td>
            <td>
              <span class="status-badge status-active">
                Actif
              </span>
            </td>
            <td>
              <button class="btn btn-sm btn-info" (click)="viewUserDetails(user)">
                <i class="fas fa-eye"></i> Détails
              </button>
            </td>
          </tr>
        </tbody>
      </table>

      <div class="no-users" *ngIf="users.length === 0">
        <i class="fas fa-users"></i>
        <p>Aucun utilisateur trouvé</p>
      </div>
    </div>
  </div>

  <!-- Modal de détails de la demande -->
  <div class="modal" [class.show]="showRequestDetails" *ngIf="showRequestDetails && selectedRequest">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Détails de la demande #{{selectedRequest.id}}</h5>
          <button type="button" class="close" (click)="closeModal()">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="request-details">
            <div class="detail-row">
              <span class="detail-label">Type:</span>
              <span class="detail-value">{{selectedRequest.type}}</span>
            </div>

            <div class="detail-row">
              <span class="detail-label">Employé:</span>
              <span class="detail-value">
                {{selectedRequest.firstname || selectedRequest.user?.firstname}}
                {{selectedRequest.lastname || selectedRequest.user?.lastname}}
              </span>
            </div>

            <div class="detail-row">
              <span class="detail-label">Status:</span>
              <span class="detail-value">
                <span [class]="getStatusClass(selectedRequest.status || '')">
                  {{selectedRequest.status}}
                </span>
              </span>
            </div>

            <!-- Dates de début et fin -->
            <div class="detail-row" *ngIf="selectedRequest.start_date">
              <span class="detail-label">Date de début:</span>
              <span class="detail-value">{{selectedRequest.start_date | date:'dd/MM/yyyy'}}</span>
            </div>
            <div class="detail-row" *ngIf="selectedRequest.end_date">
              <span class="detail-label">Date de fin:</span>
              <span class="detail-value">{{selectedRequest.end_date | date:'dd/MM/yyyy'}}</span>
            </div>

            <div class="detail-row" *ngIf="selectedRequest.description">
              <span class="detail-label">Description:</span>
              <span class="detail-value">{{selectedRequest.description}}</span>
            </div>

            <!-- Observation du chef -->
            <div class="chef-observation" *ngIf="selectedRequest.chef_observation">
              <h6><i class="fas fa-user-tie"></i> Observation du chef:</h6>
              <div class="observation-content">
                <p>{{selectedRequest.chef_observation}}</p>
              </div>
            </div>

            <!-- Réponse de l'admin -->
            <div class="admin-response" *ngIf="selectedRequest.admin_response">
              <h6><i class="fas fa-user-shield"></i> Réponse de l'administrateur:</h6>
              <div class="response-content">
                <p>{{selectedRequest.admin_response}}</p>
              </div>
            </div>

            <!-- Zone de commentaire pour l'admin -->
            <div class="admin-comment-section" *ngIf="canProcessRequest(selectedRequest)">
              <h6>Commentaire administrateur:</h6>
              <textarea class="form-control"
                       rows="3"
                       [(ngModel)]="adminResponse"
                       placeholder="Ajoutez votre commentaire (optionnel)..."></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="closeModal()">Fermer</button>

          <!-- Boutons pour les demandes en attente (pas encore traitées par le chef) -->
          <div class="admin-actions" *ngIf="isPendingRequest(selectedRequest)">
            <button class="btn btn-success" (click)="approveRequest(selectedRequest)">
              <i class="fas fa-check"></i> Approuver directement
            </button>
            <button class="btn btn-danger" (click)="rejectRequest(selectedRequest)">
              <i class="fas fa-times"></i> Rejeter directement
            </button>
          </div>

          <!-- Boutons pour les demandes traitées par le chef -->
          <div class="final-actions" *ngIf="isChefProcessed(selectedRequest)">
            <button class="btn btn-success" (click)="finalApproveRequest(selectedRequest)">
              <i class="fas fa-check-double"></i> Approbation finale
            </button>
            <button class="btn btn-danger" (click)="finalRejectRequest(selectedRequest)">
              <i class="fas fa-ban"></i> Rejet final
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal pour ajouter une réponse finale -->
  <div class="modal" [class.show]="showResponseModal" *ngIf="showResponseModal">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">{{responseModalTitle}}</h5>
          <button type="button" class="close" (click)="cancelResponse()">
            <span>&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="adminResponse">Votre réponse:</label>
            <textarea class="form-control" id="adminResponse" rows="3" [(ngModel)]="adminResponse"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="cancelResponse()">Annuler</button>
          <button type="button" class="btn" [class.btn-success]="responseAction === 'approve'" [class.btn-danger]="responseAction === 'reject'" (click)="submitResponse()">
            {{responseAction === 'approve' ? 'Confirmer l\'approbation' : 'Confirmer le rejet'}}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
